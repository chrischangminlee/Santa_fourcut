<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>ì‚°íƒ€ë„¤ì»· | Santa AI í¬í† ë¶€ìŠ¤</title>
    <meta
      name="description"
      content="Santa AIë¡œ í•œ ë²ˆì— ì™„ì„±í•˜ëŠ” ì‚°íƒ€ë„¤ì»·. ì‚¬ì§„ ì—…ë¡œë“œ í›„ ì‚°íƒ€ ë¬´ë“œë¥¼ ì…íˆê³  ë„¤ì»·ìœ¼ë¡œ ì €ì¥í•˜ì„¸ìš”."
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Jua&family=Space+Grotesk:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #050913;
        --bg-accent: #0d1428;
        --panel: rgba(9, 17, 40, 0.82);
        --primary: #ff4f64;
        --primary-dark: #d43a48;
        --border: rgba(255, 255, 255, 0.08);
        --soft-white: #fff7f1;
        --mint: #9bd9ce;
        --secondary: #f0b90b;
        --text-muted: rgba(255, 255, 255, 0.7);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", "Gowun Dodum", sans-serif;
        color: var(--soft-white);
        background: radial-gradient(circle at top, #101b38 10%, #050913 65%);
        min-height: 100vh;
        padding: 0;
        line-height: 1.4;
      }

      .snow-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        background-image: radial-gradient(
            rgba(255, 255, 255, 0.2) 1px,
            transparent 1px
          ),
          radial-gradient(rgba(255, 255, 255, 0.12) 1px, transparent 1px);
        background-size: 120px 120px, 80px 80px;
        opacity: 0.4;
        animation: snowfall 18s linear infinite;
        z-index: 0;
      }

      @keyframes snowfall {
        from {
          transform: translateY(-10px);
        }
        to {
          transform: translateY(10px);
        }
      }

      .hero {
        position: relative;
        padding: 80px 20px 20px;
        text-align: center;
      }

      .hero h1 {
        font-size: clamp(32px, 6vw, 64px);
        margin-bottom: 16px;
        font-family: "Jua", cursive;
        color: var(--primary);
      }

      .hero p {
        margin: 0 auto;
        max-width: 680px;
        font-size: 1.1rem;
        color: var(--text-muted);
      }

      .hero-linkedin {
        position: absolute;
        top: 24px;
        right: 24px;
      }

      .hero-actions {
        margin-top: 32px;
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .btn {
        border: none;
        cursor: pointer;
        border-radius: 28px;
        font-size: 1rem;
        padding: 14px 28px;
        font-weight: 600;
        color: var(--soft-white);
        background: linear-gradient(120deg, var(--primary), #ff8a7a);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 10px 25px rgba(255, 79, 100, 0.35);
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 18px 30px rgba(255, 79, 100, 0.4);
      }

      .btn--ghost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: none;
      }

      main {
        position: relative;
        z-index: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 28px;
        padding: 28px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(18px);
      }

      .panel h2 {
        margin: 0 0 12px;
        font-size: 1.5rem;
      }

      .panel p {
        margin: 0;
        color: var(--text-muted);
      }

      .step-label {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        font-weight: 600;
        margin-bottom: 12px;
      }

      .upload-panel {
        display: grid;
        gap: 24px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        align-items: start;
      }

      .dropzone {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 24px;
        padding: 32px;
        text-align: center;
        transition: border-color 0.3s ease, transform 0.2s ease;
        background: rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }

      .dropzone:hover,
      .dropzone.is-dragover {
        border-color: var(--primary);
        transform: translateY(-2px);
      }

      .dropzone-icon {
        font-size: 48px;
        margin-bottom: 12px;
      }

      .dropzone small {
        display: block;
        color: var(--text-muted);
        margin-top: 8px;
      }

      .preview-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .preview-card {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.12);
        width: 140px;
        aspect-ratio: 3 / 4;
      }

      .preview-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .preview-card button {
        position: absolute;
        top: 8px;
        right: 8px;
        border: none;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        width: 32px;
        height: 32px;
        cursor: pointer;
      }

      .control-row {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        align-items: center;
      }

      .control-row label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 6px;
        color: var(--text-muted);
      }

      .prompt-area textarea {
        width: 100%;
        min-height: 90px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        padding: 12px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--soft-white);
        resize: vertical;
      }

      .api-inputs {
        display: grid;
        gap: 14px;
      }

      .api-inputs input {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        padding: 12px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--soft-white);
      }

      .provider-card {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        padding: 16px;
        margin-top: 12px;
        background: rgba(255, 255, 255, 0.03);
      }

      .status {
        min-height: 24px;
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .status--success {
        color: #8ddfa4;
      }

      .status--error {
        color: #ffb4c0;
      }

      .result-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .strip-preview {
        min-height: 240px;
        display: flex;
        justify-content: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 24px;
        border: 1px dashed rgba(255, 255, 255, 0.15);
      }

      .strip {
        display: flex;
        flex-direction: column;
        gap: 18px;
        padding: 20px 26px 26px;
        border-radius: 28px;
        background: #fff7f1;
        border: 4px solid #f4d9cf;
        width: min(720px, 100%);
      }

      .strip-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 12px 18px;
        border-radius: 18px;
        border: 2px dashed rgba(255, 79, 100, 0.25);
        background: rgba(255, 255, 255, 0.7);
        position: relative;
      }

      .strip-ig {
        font-weight: 600;
        font-size: 0.95rem;
        color: #da3d4a;
        display: flex;
        gap: 8px;
        align-items: center;
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
      }

      .strip-logo {
        font-family: "Jua", sans-serif;
        font-size: 1.6rem;
        color: #111;
        letter-spacing: 1px;
        text-align: center;
      }

      .strip-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }

      .strip-frame {
        position: relative;
        overflow: hidden;
        border-radius: 22px;
        aspect-ratio: 3 / 4;
        border: 4px solid #f2d6cf;
        width: 100%;
      }

      .strip-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .result-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      footer {
        text-align: center;
        padding: 40px 0 60px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .tips-list {
        display: grid;
        gap: 10px;
        margin-top: 16px;
      }

      .tips-list li {
        list-style: none;
        padding: 10px 14px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .pose-list {
        margin: 0 0 20px 0;
        padding-left: 22px;
        color: var(--text-muted);
      }

      .pose-list li {
        margin-bottom: 6px;
        line-height: 1.4;
      }

      @media (max-width: 768px) {
        .panel {
          padding: 22px;
        }

        .strip {
          width: 100%;
          padding: 18px;
        }

        .strip-grid {
          grid-template-columns: 1fr;
        }

        .strip-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
          position: static;
        }

        .strip-ig {
          position: static;
          transform: none;
        }

        .hero-linkedin {
          position: static;
          display: inline-flex;
          margin: 0 auto 16px;
          order: -1;
        }

        .hero .step-label {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="snow-layer" aria-hidden="true"></div>
    <header class="hero">
      <a
        class="btn hero-linkedin"
        href="https://www.linkedin.com/in/chrislee9407/"
        target="_blank"
        rel="noreferrer noopener"
      >
        ê°œë°œì ë§í¬ë“œì¸
      </a>
      <div class="step-label">AI PHOTOBOOTH</div>
      <h1>ì‚°íƒ€ë„¤ì»· âœ¶ Santa AI</h1>
      <p>
        ì°¸ì¡° ì‚¬ì§„ 1ì¥ë§Œ ì—…ë¡œë“œí•˜ì„¸ìš”. ì‚°íƒ€ AIê°€ ë„¤ ì»·ì„ ë§Œë“¤ì–´ ë”°ëœ»í•œ ì‚°íƒ€
        ìŠ¤í† ë¦¬ë¥¼ ì™„ì„±í•©ë‹ˆë‹¤.
      </p>
      <div class="hero-actions">
        <button class="btn" id="hero-upload">ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>
      </div>
    </header>

    <main>
      <section class="panel upload-panel">
        <div>
          <div class="step-label">STEP 1</div>
          <h2>ì‚¬ì§„ ì—…ë¡œë“œ</h2>
          <p>ë³¸ì¸ ì‚¬ì§„ 1ì¥ì„ ì—…ë¡œë“œí•˜ë©´ ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëª¨ë“  í¬ì¦ˆë¥¼ ë§Œë“­ë‹ˆë‹¤.</p>
          <div class="dropzone" id="dropzone" role="button" tabindex="0">
            <input
              type="file"
              id="file-input"
              accept="image/*"
              multiple
              hidden
            />
            <div class="dropzone-icon">ğŸ…</div>
            <strong>íŒŒì¼ ì„ íƒ ë˜ëŠ” ëŒì–´ë‹¤ ë†“ê¸°</strong>
            <small>JPG Â· PNG Â· HEIC / ë‹¨ 1ì¥ì˜ ì°¸ì¡° ì‚¬ì§„ë§Œ í•„ìš”í•´ìš”</small>
          </div>
          <div style="margin-top: 20px">
            <h3 style="margin: 0 0 10px; font-size: 1rem; color: var(--text-muted)">
              ì—…ë¡œë“œí•œ ì°¸ì¡° ì‚¬ì§„
            </h3>
            <div class="preview-grid" id="preview-grid">
              <p
                style="
                  flex-basis: 100%;
                  color: var(--text-muted);
                  text-align: center;
                  margin: 0;
                "
              >
                ì•„ì§ ì‚¬ì§„ì´ ì—†ì–´ìš”. ìœ„ ì˜ì—­ì— ì‚¬ì§„ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.
              </p>
            </div>
          </div>
        </div>
        <div>
          <div class="step-label">STEP 2</div>
          <h2>ë¶„ìœ„ê¸° &amp; ìš”ì²­</h2>
          <div class="prompt-area" style="margin-top: 16px">
            <label for="prompt-input">ì¶”ê°€ ìš”ì²­ (ì„ íƒ)</label>
            <textarea
              id="prompt-input"
              placeholder="ì˜ˆ: ë” ë§ì€ ëˆˆì†¡ì´, ë”°ëœ»í•œ ì¡°ëª…, ë ˆíŠ¸ë¡œ í†¤"
            ></textarea>
          </div>
        </div>
        <div>
          <div class="step-label">STEP 3</div>
          <h2>Gemini Image ì—°ê²°</h2>
          <p>Google Gemini 2.5 Flash Image ëª¨ë¸ê³¼ ì—°ê²°í•˜ì—¬ ë„¤ ê°€ì§€ í¬ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

          <div class="provider-card">
            <div class="api-inputs">
              <div>
                <label for="gemini-key">Gemini API í‚¤</label>
                <input
                  type="password"
                  id="gemini-key"
                  placeholder="Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
                  autocomplete="off"
                />
              </div>
              <div>
                <label for="gemini-model">Gemini ëª¨ë¸</label>
                <input
                  type="text"
                  id="gemini-model"
                  value="gemini-2.5-flash-image"
                />
              </div>
            </div>
            <small style="display:block;margin-top:10px;color:var(--text-muted)">
              ì°¸ì¡° ì‚¬ì§„ê³¼ í‚¤ëŠ” ë¡œì»¬ dev ì„œë²„ë¥¼ ê±°ì³ Google Gemini APIë¡œë§Œ ì „ë‹¬ë©ë‹ˆë‹¤.
            </small>
          </div>

          <small style="display: block; margin-top: 10px; color: var(--text-muted)"
            >í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, ìƒˆë¡œê³ ì¹¨ ì‹œ ë‹¤ì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</small
          >
        </div>
      </section>

      <section class="panel">
        <div class="step-label">STEP 4</div>
        <h2>ì‚°íƒ€ë„¤ì»· ë§Œë“¤ê¸°</h2>
        <div class="control-row" style="margin: 12px 0 20px">
          <button class="btn" id="generate-btn" disabled>ì‚°íƒ€ ë³€í™˜ ì‹œì‘</button>
          <button class="btn btn--ghost" id="reset-btn">ì´ˆê¸°í™”</button>
        </div>
        <p style="color: var(--text-muted); margin: 6px 0 18px">
          ì°¸ì¡° ì‚¬ì§„ 1ì¥ë§Œìœ¼ë¡œ ì•„ë˜ ë„¤ ê°€ì§€ ì‚°íƒ€ í¬ì¦ˆë¥¼ ìˆœì„œëŒ€ë¡œ ë§Œë“¤ì–´ ë“œë¦½ë‹ˆë‹¤.
        </p>
        <ol class="pose-list">
          <li>1ì»·: ì…ìˆ ì— ì†ê°€ë½ì„ ìœ™í¬</li>
          <li>2ì»·: ì„ ë¬¼ì„ í¬ì¥í•˜ë©° ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ëŠ” ì¥ë©´.</li>
          <li>3ì»·: ì–´ê¹¨ì— ì„ ë¬¼ ìë£¨ë¥¼ ë©˜ ì—­ë™ì ì¸ í¬ì¦ˆ.</li>
          <li>4ì»·: í˜¸í˜¸í˜¸ ì›ƒìœ¼ë©° ì¦ê±°ìš´ ë¶„ìœ„ê¸°ë¥¼ í‘œí˜„ </li>
        </ol>
        <div class="status" id="status">ì°¸ì¡° ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ ì¤€ë¹„ë©ë‹ˆë‹¤.</div>
      </section>

      <section class="panel result-panel" aria-live="polite">
        <h2>ì‚°íƒ€ë„¤ì»· ë¯¸ë¦¬ë³´ê¸°</h2>
        <div class="strip-preview" id="strip-preview">
          <p style="color: var(--text-muted)">
            ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. Gemini Image ë³€í™˜ì„ ì‹¤í–‰í•œ ë’¤ í™•ì¸í•˜ì„¸ìš”.
          </p>
        </div>
        <div class="result-actions">
          <button class="btn" id="download-strip" disabled>
            ë„¤ì»· ì´ë¯¸ì§€ ì €ì¥
          </button>
        </div>
      </section>

      <section class="panel">
        <h2>ì‘ì—… íŒ</h2>
        <p>ë” íƒ„íƒ„í•œ ê²°ê³¼ë¥¼ ìœ„í•´ ì•„ë˜ íŒì„ ì°¸ê³ í•´ ì£¼ì„¸ìš”.</p>
        <ul class="tips-list" id="tips-list">
          <li>ì–¼êµ´ì´ ì •ë©´ìœ¼ë¡œ ë³´ì´ë©´ ê° í¬ì¦ˆì— ì°©ìš©ë˜ëŠ” ì‚°íƒ€ ì†Œí’ˆì´ ë” ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤.</li>
          <li>Gemini APIëŠ” ì…ë ¥ í”„ë¡¬í”„íŠ¸(ì¶”ê°€ ìš”ì²­)ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬ë°›ìœ¼ë¯€ë¡œ ì›í•˜ëŠ” ë¶„ìœ„ê¸°ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”.</li>
        </ul>
      </section>
    </main>

    <footer>Â© 2025 ì‚°íƒ€ë„¤ì»· Â· powered by Santa AI magic</footer>

    <script>
      const STRIP_FRAMES = 4;
      const STRIP_COLUMNS = 2;
      const STRIP_ROWS = 2;
      const SANTA_POSES = [
        {
          title: "Pose 1",
          description: "ì…ìˆ ì— ì†ê°€ë½ì„ ëŒ€ê³  ìœ™í¬í•˜ëŠ” ì‚°íƒ€",
        },
        {
          title: "Pose 2",
          description: "ì„ ë¬¼ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ë©° í¬ì¥í•˜ëŠ” ì‚°íƒ€",
        },
        {
          title: "Pose 3",
          description: "ì»¤ë‹¤ë€ ì„ ë¬¼ ìë£¨ë¥¼ ì–´ê¹¨ì— ë©˜ ì—­ë™ì ì¸ í¬ì¦ˆ",
        },
        {
          title: "Pose 4",
          description: "ë°°ë¥¼ ì¡ê³  í˜¸í˜¸í˜¸ ì›ƒëŠ” ì¦ê±°ìš´ ì¥ë©´",
        },
      ];
      const state = {
        files: [],
        processed: [],
        prompt: "",
        isProcessing: false,
      };

      const fileInput = document.getElementById("file-input");
      const dropzone = document.getElementById("dropzone");
      const previewGrid = document.getElementById("preview-grid");
      const generateBtn = document.getElementById("generate-btn");
      const resetBtn = document.getElementById("reset-btn");
      const statusEl = document.getElementById("status");
      const stripPreview = document.getElementById("strip-preview");
      const downloadBtn = document.getElementById("download-strip");
      const promptInput = document.getElementById("prompt-input");
      const geminiKeyInput = document.getElementById("gemini-key");
      const geminiModelInput = document.getElementById("gemini-model");
      const heroUpload = document.getElementById("hero-upload");
      const guideButtons = [];

      heroUpload.addEventListener("click", () => fileInput.click());
      guideButtons.forEach((btn) =>
        btn.addEventListener("click", () =>
          window.alert("ìƒ˜í”Œ ë„¤ì»·ì€ ê³§ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤. ì§ì ‘ ë§Œë“¤ì–´ë³´ì„¸ìš”!")
        )
      );

      dropzone.addEventListener("click", () => fileInput.click());
      dropzone.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          fileInput.click();
        }
      });

      fileInput.addEventListener("change", (event) => {
        handleFiles(event.target.files);
        fileInput.value = "";
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        dropzone.addEventListener(eventName, (event) => {
          event.preventDefault();
          event.stopPropagation();
          dropzone.classList.add("is-dragover");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropzone.addEventListener(eventName, (event) => {
          event.preventDefault();
          event.stopPropagation();
          dropzone.classList.remove("is-dragover");
        });
      });

      dropzone.addEventListener("drop", (event) => {
        const files = event.dataTransfer?.files;
        if (files) {
          handleFiles(files);
        }
      });

      promptInput.addEventListener("input", (event) => {
        state.prompt = event.target.value.trim();
      });

      generateBtn.addEventListener("click", processImages);
      downloadBtn.addEventListener("click", downloadStrip);
      resetBtn.addEventListener("click", resetWorkspace);

      function getMaxInputCount() {
        return 1;
      }

      function isReadyForGeneration() {
        return state.files.length === getMaxInputCount() && state.files.length > 0;
      }

      function updateGenerateAvailability() {
        if (state.isProcessing) {
          generateBtn.disabled = true;
          return;
        }
        generateBtn.disabled = !isReadyForGeneration();
      }

      function handleFiles(fileList) {
        const incoming = Array.from(fileList).filter((file) =>
          file.type.startsWith("image/")
        );
        if (!incoming.length) {
          updateStatus("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "error");
          return;
        }
        const maxInputs = getMaxInputCount();
        const slots = maxInputs - state.files.length;
        if (slots <= 0) {
          updateStatus(
            `í˜„ì¬ ëª¨ë“œëŠ” ì°¸ì¡° ì‚¬ì§„ ${maxInputs}ì¥ë§Œ í—ˆìš©í•©ë‹ˆë‹¤.`,
            "error"
          );
          return;
        }

        const accepted = incoming.slice(0, slots);
        accepted.forEach((file) => {
          const url = URL.createObjectURL(file);
          state.files.push({ file, url });
        });

        renderPreviewGrid();
        updateStripPreview();
        const readyMsg =
          state.files.length === maxInputs
            ? "ëª¨ë“  ì°¸ì¡° ì‚¬ì§„ì´ ì¤€ë¹„ëì–´ìš”."
            : `${state.files.length}/${maxInputs}ì¥ ì—…ë¡œë“œë¨`;
        if (incoming.length > accepted.length) {
          const skipped = incoming.length - accepted.length;
          updateStatus(
            `${readyMsg} Â· ${skipped}ì¥ì€ ì œí•œì„ ì´ˆê³¼í•´ ì œì™¸ëìŠµë‹ˆë‹¤.`,
            "info"
          );
        } else {
          updateStatus(readyMsg, "success");
        }
        updateGenerateAvailability();
      }

      function renderPreviewGrid() {
        previewGrid.innerHTML = "";
        const required = getMaxInputCount();
        if (!state.files.length) {
          previewGrid.innerHTML =
            `<p style="flex-basis:100%;text-align:center;color:var(--text-muted);margin:0;">ì°¸ì¡° ì‚¬ì§„ì„ ${required}ì¥ ì˜¬ë ¤ì£¼ì„¸ìš”.</p>`;
          updateGenerateAvailability();
          return;
        }

        state.files.forEach((entry, index) => {
          const card = document.createElement("div");
          card.className = "preview-card";

          const img = document.createElement("img");
          img.src = entry.url;
          img.alt = `ì—…ë¡œë“œëœ ì‚¬ì§„ ${index + 1}`;
          card.appendChild(img);

          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.setAttribute("aria-label", "ì‚¬ì§„ ì œê±°");
          removeBtn.textContent = "âœ•";
          removeBtn.addEventListener("click", () => removeFile(index));
          card.appendChild(removeBtn);

          previewGrid.appendChild(card);
        });

        if (state.files.length < required) {
          const reminder = document.createElement("p");
          reminder.style.flexBasis = "100%";
          reminder.style.color = "var(--text-muted)";
          reminder.style.textAlign = "center";
          reminder.style.margin = "0";
          reminder.textContent = `í˜„ì¬ ${state.files.length}/${required}ì¥ì…ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ë„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.`;
          previewGrid.appendChild(reminder);
        }
        updateGenerateAvailability();
      }

      function removeFile(index) {
        const [removed] = state.files.splice(index, 1);
        if (removed) {
          URL.revokeObjectURL(removed.url);
        }
        renderPreviewGrid();
        updateStripPreview();
        updateGenerateAvailability();
        updateStatus("ì‚¬ì§„ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.", "info");
      }

      async function processImages() {
        const required = getMaxInputCount();
        if (state.files.length !== required) {
          updateStatus(
            `ì°¸ì¡° ì‚¬ì§„ ${required}ì¥ì„ ëª¨ë‘ ì—…ë¡œë“œí•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`,
            "error"
          );
          return;
        }

        const geminiKey = geminiKeyInput.value.trim();
        const geminiModel =
          geminiModelInput.value.trim() || "gemini-2.5-flash-image";
        const prompt = state.prompt;

        if (!geminiKey) {
          updateStatus("Gemini Image ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.", "error");
          return;
        }

        setLoading(true);
        disposeProcessed();
        updateStripPreview();
        updateStatus("ì‚°íƒ€ ë³€í™˜ì„ ì¤€ë¹„ ì¤‘...", "info");

        const tasks = Array.from({ length: STRIP_FRAMES }, (_, poseIndex) => ({
          entry: state.files[poseIndex % state.files.length],
          poseIndex,
        }));

        for (const [index, task] of tasks.entries()) {
          const entry = task.entry;
          try {
            const posePrompt = buildPosePrompt(task.poseIndex, prompt);
            const blob = await callGeminiImage(entry.file, {
              apiKey: geminiKey,
              model: geminiModel,
              prompt: posePrompt,
            });
            const url = URL.createObjectURL(blob);
            state.processed.push({
              blob,
              url,
              name: `santa-${task.poseIndex + 1}.jpg`,
              poseIndex: task.poseIndex,
            });
            updateStatus(
              `${index + 1}/${tasks.length} ì¥ ì²˜ë¦¬ ì™„ë£Œ`,
              "success"
            );
            updateStripPreview();
          } catch (error) {
            console.error(error);
            updateStatus(
              `Gemini ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`,
              "error"
            );
            break;
          }
        }

        downloadBtn.disabled = state.processed.length < STRIP_FRAMES;
        setLoading(false);
      }

      function getFramesForPreview() {
        return state.processed;
      }

      function buildPosePrompt(poseIndex, extraPrompt) {
        const pose = SANTA_POSES[poseIndex];
        const segments = [];
        if (pose) {
          segments.push(
            `Create a photo of this person cosplay in well-fit santa costume, very attractive and no beard for the pose "${pose.title}" (${pose.description}).`
          );
        } else {
          segments.push("Create a Santa portrait.");
        }
        segments.push(
          "Preserve the face and body identity and from the reference photo."
        );
        segments.push("Keep it focused on this single person.");
        segments.push("Use warm studio lighting, and gentle snowfall.");
        if (extraPrompt) {
          segments.push(`Extra direction: ${extraPrompt}`);
        }
        return segments.join(" ");
      }

      function updateStripPreview() {
        const frames = getFramesForPreview();
        stripPreview.innerHTML = "";

        if (frames.length < STRIP_FRAMES) {
          stripPreview.innerHTML =
            '<p style="color:var(--text-muted)">Geminië¡œ ë„¤ ê°€ì§€ ì‚°íƒ€ í¬ì¦ˆë¥¼ ëª¨ë‘ ìƒì„±í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
          return;
        }

        const normalized = getNormalizedFrames(frames);
        const strip = document.createElement("div");
        strip.className = "strip";

        const header = document.createElement("div");
        header.className = "strip-header";

        const igBadge = document.createElement("div");
        igBadge.className = "strip-ig";
        igBadge.textContent = "ğŸ“¸ @changmini.ai";

        const logo = document.createElement("div");
        logo.className = "strip-logo";
        logo.textContent = "ì‚°íƒ€ë„¤ì»·";

        header.appendChild(igBadge);
        header.appendChild(logo);
        strip.appendChild(header);

        const grid = document.createElement("div");
        grid.className = "strip-grid";

        normalized.forEach((frame, index) => {
          const frameEl = document.createElement("div");
          frameEl.className = "strip-frame";

          const img = document.createElement("img");
          img.src = frame.url;
          img.alt = `ë„¤ì»· ${index + 1}ë²ˆì§¸`;
          frameEl.appendChild(img);

          grid.appendChild(frameEl);
        });

        strip.appendChild(grid);
        stripPreview.appendChild(strip);
      }

      function getNormalizedFrames(frames) {
        if (!frames.length) return [];
        return Array.from(
          { length: Math.max(STRIP_FRAMES, frames.length) },
          (_, idx) => {
            const source = frames[idx % frames.length];
            if (!source) return null;
            if (typeof source.poseIndex === "number") {
              return source;
            }
            return { ...source, poseIndex: idx };
          }
        )
          .filter(Boolean)
          .slice(0, STRIP_FRAMES);
      }

      async function downloadStrip() {
        const canvas = await buildStripCanvas();
        if (!canvas) {
          updateStatus("ì•„ì§ ì™„ë£Œëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë³€í™˜ì„ ëª¨ë‘ ë§ˆì¹œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        canvas.toBlob((blob) => {
          if (!blob) return;
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "santa-4cut.png";
          document.body.appendChild(link);
          link.click();
          link.remove();
          setTimeout(() => URL.revokeObjectURL(url), 500);
          updateStatus("ë„¤ì»· ì´ë¯¸ì§€ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤!", "success");
        }, "image/png");
      }

      async function buildStripCanvas() {
        const frames = getFramesForPreview();
        if (frames.length < STRIP_FRAMES) return null;
        const normalized = getNormalizedFrames(frames);

        const frameWidth = 720;
        const frameHeight = 960;
        const gutter = 40;
        const headerHeight = 150;
        const columns = STRIP_COLUMNS;
        const rows = STRIP_ROWS;

        const canvas = document.createElement("canvas");
        canvas.width = frameWidth * columns + gutter * (columns + 1);
        canvas.height =
          headerHeight + gutter * 3 + frameHeight * rows + gutter * (rows - 1);

        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#fff5f1";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawStripHeaderCanvas(ctx, {
          x: gutter,
          y: gutter,
          width: canvas.width - gutter * 2,
          height: headerHeight,
        });

        for (const [index, frame] of normalized.entries()) {
          const img = await blobToImage(frame.blob || frame.file);
          const row = Math.floor(index / columns);
          const col = index % columns;
          const x = gutter + col * (frameWidth + gutter);
          const y = headerHeight + gutter * 2 + row * (frameHeight + gutter);
          drawRoundedImage(ctx, img, x, y, frameWidth, frameHeight, 40);
          addOverlay(ctx, x, y, frameWidth, frameHeight);
          addSnowParticles(ctx, x, y, frameWidth, frameHeight);
        }

        return canvas;
      }

      function drawStripHeaderCanvas(ctx, rect) {
        const { x, y, width, height } = rect;
        ctx.save();
        roundRect(ctx, x, y, width, height, 40);
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#f2d6cf";
        ctx.stroke();

        // Instagram badge (top-left)
        const igCenterX = x + 50;
        const igCenterY = y + height / 2;
        ctx.fillStyle = "#ff4f64";
        ctx.beginPath();
        ctx.arc(igCenterX, igCenterY, 24, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = "bold 28px 'Space Grotesk', sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("IG", igCenterX, igCenterY + 1);

        ctx.fillStyle = "#da3d4a";
        ctx.font = "600 36px 'Space Grotesk', sans-serif";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        ctx.fillText("@changmini.ai", igCenterX + 40, igCenterY);

        // Logo centered
        ctx.fillStyle = "#111";
        ctx.font = "bold 72px 'Jua', 'Space Grotesk', sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("ì‚°íƒ€ë„¤ì»·", x + width / 2, y + height / 2 + 12);
        ctx.restore();
      }

      function drawRoundedImage(ctx, img, x, y, width, height, radius) {
        ctx.save();
        roundRect(ctx, x, y, width, height, radius);
        ctx.clip();

        const { offsetX, offsetY, drawWidth, drawHeight } = contain(
          img.width,
          img.height,
          width,
          height
        );
        ctx.drawImage(img, x + offsetX, y + offsetY, drawWidth, drawHeight);
        ctx.restore();
      }

      function roundRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
      }

      function contain(srcWidth, srcHeight, maxWidth, maxHeight) {
        const ratio = Math.max(maxWidth / srcWidth, maxHeight / srcHeight);
        const drawWidth = srcWidth * ratio;
        const drawHeight = srcHeight * ratio;
        return {
          drawWidth,
          drawHeight,
          offsetX: (maxWidth - drawWidth) / 2,
          offsetY: (maxHeight - drawHeight) / 2,
        };
      }

      function addOverlay(ctx, x, y, width, height) {
        ctx.save();
        roundRect(ctx, x, y, width, height, 40);
        ctx.clip();
        const gradient = ctx.createLinearGradient(x, y, x + width, y + height);
        gradient.addColorStop(0, `rgba(255, 79, 100, 0.2)`);
        gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, width, height);
        ctx.restore();
      }

      function addSnowParticles(ctx, x, y, width, height) {
        const flakes = 40;
        ctx.save();
        ctx.fillStyle = "rgba(255,255,255,0.5)";
        for (let i = 0; i < flakes; i++) {
          const size = Math.random() * 6 + 1;
          const fx = x + Math.random() * width;
          const fy = y + Math.random() * height;
          ctx.beginPath();
          ctx.arc(fx, fy, size / 2, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.restore();
      }

      async function callGeminiImage(file, config) {
        const base64 = await blobToBase64(file);
        const response = await fetch("/api/gemini", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            prompt: config.prompt,
            model: config.model,
            apiKey: config.apiKey,
            image: {
              name: file.name,
              type: file.type || "image/jpeg",
              data: base64,
            },
          }),
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          const details = payload.text ? ` (${payload.text})` : "";
          throw new Error((payload.error || "Gemini API ì˜¤ë¥˜") + details);
        }
        const image = payload.image;
        if (!image?.data) {
          throw new Error("Gemini ì‘ë‹µì— ì´ë¯¸ì§€ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
        return base64ToBlob(
          image.data,
          image.mimeType || image.mime_type || "image/png"
        );
      }

      function blobToImage(blob) {
        return new Promise((resolve, reject) => {
          const url = URL.createObjectURL(blob);
          const image = new Image();
          image.onload = () => {
            URL.revokeObjectURL(url);
            resolve(image);
          };
          image.onerror = () => {
            URL.revokeObjectURL(url);
            reject(new Error("ì´ë¯¸ì§€ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
          };
          image.src = url;
        });
      }

      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            const result = reader.result;
            if (typeof result === "string") {
              const comma = result.indexOf(",");
              resolve(comma >= 0 ? result.slice(comma + 1) : result);
            } else {
              reject(new Error("ì´ë¯¸ì§€ë¥¼ ì¸ì½”ë”©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."));
            }
          };
          reader.onerror = () => reject(new Error("ì´ë¯¸ì§€ë¥¼ ì¸ì½”ë”©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."));
          reader.readAsDataURL(blob);
        });
      }

      function base64ToBlob(base64, mimeType) {
        const binary = atob(base64);
        const len = binary.length;
        const buffer = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          buffer[i] = binary.charCodeAt(i);
        }
        return new Blob([buffer], { type: mimeType });
      }

      function updateStatus(message, type = "info") {
        statusEl.textContent = message;
        statusEl.className = `status${
          type === "success"
            ? " status--success"
            : type === "error"
            ? " status--error"
            : ""
        }`;
      }

      function setLoading(isLoading) {
        state.isProcessing = isLoading;
        updateGenerateAvailability();
        generateBtn.textContent = isLoading ? "ë³€í™˜ ì¤‘..." : "ì‚°íƒ€ ë³€í™˜ ì‹œì‘";
      }

      function disposeProcessed() {
        state.processed.forEach((item) => URL.revokeObjectURL(item.url));
        state.processed = [];
      }

      function resetWorkspace() {
        state.files.forEach((item) => URL.revokeObjectURL(item.url));
        state.files = [];
        disposeProcessed();
        previewGrid.innerHTML =
          '<p style="flex-basis:100%;text-align:center;color:var(--text-muted);margin:0;">ì‚¬ì§„ì„ ë‹¤ì‹œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</p>';
        updateStripPreview();
        downloadBtn.disabled = true;
        state.isProcessing = false;
        updateGenerateAvailability();
        updateStatus("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.", "info");
      }
    </script>
  </body>
</html>
